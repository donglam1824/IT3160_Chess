from copy import deepcopy
from Base.ChessBoardClass import ChessBoard
from visualiser.visualiser import Visualiser

maxing_player = "White"
board = ChessBoard()

@Visualiser(node_properties_kwargs={"shape":"record","color":"#f57542", "style":"filled", "fillcolor":"grey"})
def miniMax(best_value, piece_index, best_move , is_max, depth, board = ChessBoard, alpha = int, beta = int):
        #Khởi tạo
        if is_max: best_value = -float("Inf")
        else: best_value = float("Inf")
        #Kiểm tra kết thúc game hoặc đến đáy
        if(board.endGame()[0] == True or depth <= 0):
            return [board.evaluateBoard(maxing_player), "",""]
        #Xem từng nước đi một
        if((is_max == True and maxing_player == "White") or (is_max == False and maxing_player == "Black")):
            for piece in board.player_white.chess_pieces:
                movable_tile = piece.available_move
                for move in movable_tile:
                    copy_board = deepcopy(board)
                    p_index = board.player_white.chess_pieces.index(piece)
                    copy_piece = copy_board.player_white.chess_pieces[p_index]
                    #Tạo copy của bàn cờ
                    copy_piece.makeMove(move, copy_board)
                    #Đệ quy, tìm nhánh dưới
                    board_value = miniMax(best_value, piece_index, best_move, not is_max, 
                                               depth - 1, copy_board, alpha, beta)[0]
                    print(board_value, end = " ")
                    if(best_value < board_value and is_max == True): 
                        best_value = board_value
                        piece_index = p_index
                        best_move = move
                        alpha = max(best_value, alpha)
                        print("$max", end = " ")
                    if(best_value > board_value and is_max == False): 
                        best_value = board_value
                        piece_index = p_index
                        best_move = move
                        beta = min(best_value, beta)
                        print("$min", end = " ")
                    if(beta <= alpha): 
                        print("a-b break", end= " ")
                        break
                if(beta <= alpha): 
                    break
        elif((is_max == True and maxing_player == "Black") or (is_max == False and maxing_player == "White")):
            for piece in board.player_black.chess_pieces:
                movable_tile = piece.available_move
                for move in movable_tile:
                    copy_board = deepcopy(board)
                    p_index = board.player_black.chess_pieces.index(piece)
                    #Tạo copy của bàn cờ
                    copy_piece = copy_board.player_black.chess_pieces[p_index]
                    copy_piece.makeMove(move, copy_board)
                    #Đệ quy, tìm nhánh dưới
                    board_value = miniMax(best_value, piece_index ,best_move, not is_max, 
                                               depth - 1, copy_board, alpha, beta)[0]
                    print(board_value, end = " ")
                    if(best_value < board_value and is_max == True): 
                        best_value = board_value
                        piece_index = p_index
                        best_move = move
                        alpha = max(best_value, alpha)
                        print("$max", end = " ")
                    if(best_value > board_value and is_max == False): 
                        best_value = board_value
                        piece_index = p_index
                        best_move = move
                        beta = min(best_value, beta)
                        print("$min", end = " ")
                    if(beta <= alpha): 
                        print("a-b break", end= " ")
                        break
                if(beta <= alpha): break
        print()
        print(best_value, piece_index ,best_move, depth, "Max" if(is_max) else "Min", alpha, beta)
        return [best_value, piece_index , best_move]

miniMax(0, "", "", True, 2, board, -float("Inf"), float("Inf"))

Visualiser.make_animation("sd.gif", 0)